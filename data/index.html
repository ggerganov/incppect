<html>
    <head>
        <script language="javascript" type="text/javascript">
            var incppect = {
                // websocket data
                ws: null,
                ws_uri: 'ws://' + window.location.hostname + ':' + window.location.port + '/incppect',

                // vars data
                nvars: 0,
                vars_map: {},
                var_to_id: {},
                id_to_var: {},

                // requests data
                requests: [],
                requests_old: [],
                requests_new_vars: false,
                requests_regenerate: true,

                // timestamps
                t_start_ms: null,
                t_frame_begin_ms: null,
                t_requests_last_update_ms: null,

                // constants
                k_var_delim: ' ',
                k_requests_update_freq_ms: 50,

                src_render: null,
                output: null,

                timestamp: function() {
                    return window.performance && window.performance.now && window.performance.timing &&
                        window.performance.timing.navigationStart ? window.performance.now() + window.performance.timing.navigationStart : Date.now();
                },

                init: function() {
                    this.output = document.getElementById("incppect");

                    var onclose = this.onclose.bind(this);
                    var onmessage = this.onmessage.bind(this);

                    this.ws = new WebSocket(this.ws_uri);
                    this.ws.binaryType = 'arraybuffer';
                    this.ws.onopen = function(evt) { };
                    this.ws.onclose = function(evt) { onclose(evt) };
                    this.ws.onmessage = function(evt) { onmessage(evt) };
                    this.ws.onerror = function(evt) { };

                    this.t_start_ms = this.timestamp();
                    this.t_requests_last_update_ms = this.timestamp() - this.k_requests_update_freq_ms;

                    this.src_render = this.render.toString().match(/function[^{]+\{([\s\S]*)\}$/)[1];
                    document.getElementById('src_render').value = this.src_render;

                    var this_ref = this;
                    document.getElementById('src_render').addEventListener('keydown', function (e){
                        if ((e.ctrlKey || e.metaKey) && (e.keyCode == 13 || e.keyCode == 10)) {
                            this_ref.render = new Function(this.value);
                        }
                    }, false);

                    window.requestAnimationFrame(this.loop.bind(this));
                },

                loop: function() {
                    if (this.ws == null) {
                        setTimeout(this.init.bind(this), 1000);
                        return;
                    }

                    if (this.ws.readyState !== this.ws.OPEN) {
                        window.requestAnimationFrame(this.loop.bind(this));
                        return;
                    }

                    this.t_frame_begin_ms = this.timestamp();
                    this.requests_regenerate = this.t_frame_begin_ms - this.t_requests_last_update_ms > this.k_requests_update_freq_ms;

                    if (this.requests_regenerate) {
                        this.requests_old = this.requests;
                        this.requests = [];

                        try {
                            this.render();
                        } catch(err) {
                            this.output.innerHTML = 'Failed to render state: ' + err;
                        }
                    }

                    if (this.requests_regenerate) {
                        if (this.requests_new_vars) {
                            this.send_var_to_id_map();
                            this.requests_new_vars = false;
                        }
                        this.send_requests();
                        this.t_requests_last_update_ms = this.timestamp();
                    }

                    window.requestAnimationFrame(this.loop.bind(this));
                },

                get: function(path) {
                    for (var i = 1; i < arguments.length; i++) {
                        path = path.replace('%d', arguments[i]);
                    }

                    if (!(path in this.vars_map)) {
                        this.vars_map[path] = new ArrayBuffer();
                        this.var_to_id[path] = this.nvars;
                        this.id_to_var[this.nvars] = path;
                        ++this.nvars;

                        this.requests_new_vars = true;
                    }

                    if (this.requests_regenerate) {
                        this.requests.push(this.var_to_id[path]);
                    }

                    return this.vars_map[path];
                },

                get_int: function(path) {
                    var abuf = this.get.apply(this, arguments);
                    return new Int32Array(abuf)[0];
                },

                get_float: function(path) {
                    var abuf = this.get.apply(this, arguments);
                    return new Float32Array(abuf)[0];
                },

                send_var_to_id_map: function() {
                    var msg = '';
                    var delim = this.k_var_delim;
                    for (var key in this.var_to_id) {
                        var nidxs = 0;
                        var idxs = delim;
                        var keyp = key.replace(/\[\d*\]/g, function(m) { ++nidxs; idxs += m.replace(/[\[\]]/g, '') + delim; return '[%d]'; });
                        msg += keyp + delim + this.var_to_id[key].toString() + delim + nidxs + idxs;
                    }
                    var data = new Int8Array(4 + msg.length + 1);
                    data[0] = 1;
                    var enc = new TextEncoder();
                    data.set(enc.encode(msg), 4);
                    data[4 + msg.length] = 0;
                    this.ws.send(data);
                },

                send_requests: function() {
                    var same = true;
                    if (this.requests.length !== this.requests_old.length){
                        same = false;
                    } else {
                        for (var i = 0; i < this.requests.length; ++i) {
                            if (this.requests[i] !== this.requests_old[i]) {
                                same = false;
                                break;
                            }
                        }
                    }

                    if (same) {
                        var data = new Int32Array(1);
                        data[0] = 3;
                        this.ws.send(data);
                    } else {
                        var data = new Int32Array(this.requests.length + 1);
                        data.set(new Int32Array(this.requests), 1);
                        data[0] = 2;
                        this.ws.send(data);
                    }
                },

                onclose: function(evt) {
                    this.nvars = 0;
                    this.vars_map = {};
                    this.var_to_id = {};
                    this.id_to_var = {};
                    this.requests_old = null;
                    this.ws = null;
                },

                onmessage: function(buf) {
                    var offset = 0;
                    var offset_new = 0;
                    var int_view = new Int32Array(buf.data);
                    var total_size = buf.data.byteLength;
                    var id = 0;
                    var len = 0;
                    while (4*offset < total_size) {
                        id = int_view[offset];
                        len = int_view[offset + 1];
                        offset += 2;
                        offset_new = offset + len/4;
                        this.vars_map[this.id_to_var[id]] = buf.data.slice(4*offset, 4*offset_new);
                        offset = offset_new;
                    }
                },
            }

            incppect.render = function() {
                var nclients = this.get_int('incppect.nclients');
                var tx_total = this.get_int('incppect.tx_total');
                var rx_total = this.get_int('incppect.rx_total');

                var ncircles = this.get_int('state.ncircles');
                var dt = this.get_float('state.dt');
                var energy = this.get_float('state.energy');

                var show_ids = document.getElementById('show_ids').checked;
                var show_velocities = document.getElementById('show_velocities').checked;

                var canvas = document.getElementById("canvas_circles");
                var width = canvas.width;
                var height = canvas.height;
                var ctx = canvas.getContext("2d");

                this.output.innerHTML = 'nclients = ' + nclients;
                this.output.innerHTML += '<br>tx total = ' + tx_total + ' bytes';
                this.output.innerHTML += '<br>rx total = ' + rx_total + ' bytes';
                this.output.innerHTML += '<br>';
                this.output.innerHTML += '<br>ncircles = ' + ncircles;
                this.output.innerHTML += '<br>dt = ' + dt.toFixed(4);
                this.output.innerHTML += '<br>energy = ' + energy.toFixed(4);

                ctx.clearRect(0, 0, width, height);
                for (var i = 0; i < ncircles; ++i) {
                    // get c++ data about i'th circle
                    var r = this.get_float('state.circle[%d].r', i);
                    var m = this.get_float('state.circle[%d].m', i);
                    var x = this.get_float('state.circle[%d].x', i);
                    var y = this.get_float('state.circle[%d].y', i);

                    // canvas coordinates
                    var cx = 0.5*(1.0 + x)*width;
                    var cy = 0.5*(1.0 + y)*height;

                    ctx.beginPath();

                    ctx.arc(cx, cy, 0.5*width*r, 0, 2 * Math.PI);

                    if (show_ids) {
                        ctx.fillText(i, cx - 4, cy - 0.5*width*r - 2);
                    }

                    if (show_velocities) {
                        var vx = this.get_float('state.circle[%d].vx', i);
                        var vy = this.get_float('state.circle[%d].vy', i);

                        ctx.moveTo(cx, cy);
                        ctx.lineTo(cx + 0.5*30*vx*m*width, cy + 0.5*30.0*vy*m*height);
                    }

                    ctx.stroke();
                }
            }
    </script>
</head>

<body onLoad="incppect.init()">

<h3>InCppect</h3>

<div id="incppect"></div>
<div id="controls">
    <input type="checkbox" id="show_ids">Show ids</input> <br>
    <input type="checkbox" id="show_velocities">Show velocities</input> <br>
    <input type="range" min="20" max="200" value="50" class="slider" id="update_freq_ms" onChange="incppect.k_requests_update_freq_ms = this.value">Update freq [ms] <br>
</div>
<canvas id="canvas_circles" width="256" height="256" style="border:1px solid #d3d3d3;"> Your browser does not support the HTML5 canvas tag.</canvas>
<textarea rows=20 cols=120 id="src_render"></textarea>

</body>
</html>
