<html>
    <head>
        <script language="javascript" type="text/javascript">
            var output;
            var incppect;

            var incpp = {
                ws: null,
                wsUri: "ws://localhost:3000/data/test",

                nvars: 0,
                vars: {},
                vars_map: {},
                var_to_id: {},
                id_to_var: {},

                requests: [],
                requests_old: [],
                requests_new_vars: false,
                requests_regenerate: true,

                // timestamps
                t_start_ms: null,
                t_frame_begin_ms: null,
                t_requests_last_update_ms: null,

                // constants
                k_requests_update_freq_ms: 20,
                k_var_prefix: 'this.vars',
                k_var_suffix: '__abuf',
                k_var_delim: ' ',

                //received_id: null,

                output: null,

                timestamp: function() {
                    return window.performance && window.performance.now && window.performance.timing && window.performance.timing.navigationStart ? window.performance.now() + window.performance.timing.navigationStart : Date.now();
                },

                get: function(path) {
                    for (var i = 1; i < arguments.length; i++) {
                        path = path.replace('%d', arguments[i]);
                    }

                    var full_path = this.k_var_prefix + '.' + path + '.' + this.k_var_suffix;

                    if (!(path in this.vars_map)) {
                        var parts = path.split('.');
                        var cur_path = this.k_var_prefix;
                        for (var i in parts) {
                            var tmp_path = cur_path + '.' + parts[i].replace(/\[\d*\]/g, '');
                            eval('if (typeof ' + tmp_path + ' === \'undefined\') { ' + tmp_path + ' = {}; }');
                            cur_path += '.' + parts[i];
                            eval('if (typeof ' + cur_path + ' === \'undefined\') { ' + cur_path + ' = {}; }');
                        }

                        eval('if (typeof ' + full_path + ' === \'undefined\') { ' +
                            full_path + ' = new ArrayBuffer(); ' +
                            'this.vars_map[path] = new ArrayBuffer(); ' +
                            'this.var_to_id[\'' + full_path + '\'] = this.nvars;' +
                            'this.id_to_var[this.nvars] = \'' + path + '\';' +
                            '++this.nvars;' +
                            '}');

                        this.requests_new_vars = true;
                    }

                    if (this.requests_regenerate) {
                        this.requests.push(this.var_to_id[full_path]);
                    }

                    return this.vars_map[path];
                },

                get_int: function(path) {
                    var abuf = this.get.apply(this, arguments);
                    return new Int32Array(abuf)[0];
                },

                get_float: function(path) {
                    var abuf = this.get.apply(this, arguments);
                    return new Float32Array(abuf)[0];
                },

                send_var_to_id_map: function() {
                    var msg = '';
                    var delim = this.k_var_delim;
                    for (var key in this.var_to_id) {
                        var keyp = key.replace(new RegExp('^' + this.k_var_prefix + '\.'), '').replace(new RegExp('\.' + this.k_var_suffix), '');
                        var nidxs = 0;
                        var idxs = delim;
                        var keypp = keyp.replace(/\[\d*\]/g, function(m) { ++nidxs; idxs += m.replace(/[\[\]]/g, '') + delim; return '[%d]'; });
                        msg += keypp + delim + this.var_to_id[key].toString() + delim + nidxs + idxs;
                    }
                    //console.log(msg);
                    var data = new Int8Array(4 + msg.length + 1);
                    data[0] = 1;
                    var enc = new TextEncoder();
                    data.set(enc.encode(msg), 4);
                    data[4 + msg.length] = 0;
                    this.ws.send(data);
                },

                send_requests: function() {
                    var same = true;
                    if (this.requests.length !== this.requests_old.length){
                        same = false;
                    } else {
                        for (var i = 0; i < this.requests.length; ++i) {
                            if (this.requests[i] !== this.requests_old[i]) {
                                same = false;
                                break;
                            }
                        }
                    }

                    if (same) {
                        var data = new Int32Array(1);
                        data[0] = 3;
                        this.ws.send(data);
                    } else {
                        var data = new Int32Array(this.requests.length + 1);
                        data.set(new Int32Array(this.requests), 1);
                        data[0] = 2;
                        this.ws.send(data);
                    }
                },

                receive: function(buf) {
                    var offset = 0;
                    var offset_new = 0;
                    var int_view = new Int32Array(buf.data);
                    var total_size = buf.data.byteLength;
                    var id = 0;
                    var len = 0;
                    while (4*offset < total_size) {
                        id = int_view[offset];
                        len = int_view[offset + 1];
                        offset += 2;
                        offset_new = offset + len/4;
                        this.vars_map[this.id_to_var[id]] = buf.data.slice(4*offset, 4*offset_new);
                        offset = offset_new;
                    }
                },
            }

            function onOpen(evt)
            {
                writeToScreen("CONNECTED", output);
                doSend("WebSocket rocks");
            }

            function onClose(evt)
            {
                writeToScreen("DISCONNECTED", output);
            }

            function onMessage(evt)
            {
                writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>', output);
            }

            function onError(evt)
            {
                writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data, output);
            }

            function doSend(message)
            {
                writeToScreen("SENT: " + message, output);
                incpp.ws.send(message);
            }

            function writeToScreen(message, o)
            {
                pre = document.createElement("p");
                pre.style.wordWrap = "break-word";
                pre.innerHTML = message;

                if (o.childNodes.length > 5) {
                    o.removeChild(o.childNodes[0]);
                }
                o.appendChild(pre);
            }

            function vr_send() {
                doSend(document.getElementById("data_to_send").value);
            }

            function vr_send_binary() {
                const array = new Float32Array(5);

                for (var i = 0; i < array.length; ++i) {
                    array[i] = i / 2;
                }
                doSend(array);
            }

            function init() {
                output = document.getElementById("output");
                incpp.output = document.getElementById("incppect");

                incpp.ws = new WebSocket(incpp.wsUri);
                incpp.ws.binaryType = 'arraybuffer';
                incpp.ws.onopen = function(evt) { onOpen(evt) };
                incpp.ws.onclose = function(evt) { onClose(evt) };
                incpp.ws.onmessage = function(evt) {
                    incpp.receive(evt);
                };
                incpp.ws.onerror = function(evt) { onError(evt) };

                incpp.t_start_ms = incpp.timestamp();
                incpp.t_requests_last_update_ms = incpp.timestamp() - incpp.k_requests_update_freq_ms;;

                window.requestAnimationFrame(loop);
            }

            function render() {
                var nClients = incpp.get_int('nClients');
                var x = incpp.get_int('arr[%d].x', 10);

                var nCircles = incpp.get_int('state.nCircles');

				incpp.output.innerHTML = '<br>Clients = ' + nClients;
				incpp.output.innerHTML += '<br>nCircles = ' + nCircles;

                var canvas = document.getElementById("myCanvas");
                var width = canvas.width;
                var height = canvas.height;
                var ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, width, height);
                for (var i = 0; i < nCircles; ++i) {
                    var r = incpp.get_float('state.circle[%d].r', i);
                    var x = incpp.get_float('state.circle[%d].x', i);
                    var y = incpp.get_float('state.circle[%d].y', i);
                    var vx = incpp.get_float('state.circle[%d].vx', i);
                    var vy = incpp.get_float('state.circle[%d].vy', i);

                    ctx.beginPath();
                    ctx.arc(0.5*(1.0 + x)*width, 0.5*(1.0 + y)*height, width*r, 0, 2 * Math.PI);
                    ctx.stroke();
                }

                //incpp.output.innerHTML = '<pre>vars: ' + JSON.stringify(incpp.vars) + '</pre>';
                //incpp.output.innerHTML += '<pre>var_to_id: ' + JSON.stringify(incpp.var_to_id) + '</pre>';
                //incpp.output.innerHTML += '<pre>requests_old: ' + JSON.stringify(incpp.requests_old) + '</pre>';
                //incpp.output.innerHTML += '<pre>requests: ' + JSON.stringify(incpp.requests) + '</pre>';
                //incpp.output.innerHTML += '<br>Start = ' + incpp.t_start_ms;
                //incpp.output.innerHTML += '<br>Frame begin = ' + incpp.t_frame_begin_ms;
                //incpp.output.innerHTML += '<br>Clients = ' + nClients;
            }

            function loop() {
				if (incpp.ws.readyState !== incpp.ws.OPEN) {
					window.requestAnimationFrame(loop);
                    return;
				}

                incpp.t_frame_begin_ms = incpp.timestamp();
                incpp.requests_regenerate = incpp.t_frame_begin_ms - incpp.t_requests_last_update_ms > incpp.k_requests_update_freq_ms;

                if (incpp.requests_regenerate) {
                    incpp.requests_old = incpp.requests;
                    incpp.requests = [];

                    render();
                }

                if (incpp.requests_regenerate) {
                    if (incpp.requests_new_vars) {
                        console.log("   - New request vars");
                        incpp.send_var_to_id_map();
                        incpp.requests_new_vars = false;
                    }
                    incpp.send_requests();
                    incpp.t_requests_last_update_ms = incpp.timestamp();
                }

                window.requestAnimationFrame(loop);
            }

            window.requestAnimationFrame(init);
    </script>
</head>

<body>
<h2>WebSocket Test</h2>

<input type="text" id="data_to_send" value="hello"></input>
<button id="sender" onClick="vr_send()">Send</button>
<button id="sender_binary" onClick="vr_send_binary()">Send Binary</button>

<div id="incppect"></div>
<canvas id="myCanvas" width="300" height="300" style="border:1px solid #d3d3d3;"> Your browser does not support the HTML5 canvas tag.</canvas>

<div id="output"></div>
</body>
</html>
